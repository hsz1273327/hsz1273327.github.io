---
layout: post
title: "家用nas折腾"
date: 2024-12-10
author: "Hsz"
category: recommend
tags:
    - Linux
    - Synology
    - Nas
header-img: "img/home-bg-o.jpg"
update: 2024-12-10
---
# 家用nas折腾

随着一次断电把家里的nas和ups都整崩了,还毁了一块自带的msata盘.我不得不开始了新一轮的nas折腾.折腾的对象依然是蜗牛星际,系统是DSM 7.3.但这次我心里有数了,所有的硬盘全部做容灾,而且nas也将专注于特定的几个用途.

## 散热改造

蜗牛星际的最大问题其实是散热,这玩意儿就是个大闷罐,原版只有一个8025风扇在屁股后面排风,而硬盘笼背板又直接挡在排风扇前面,风道差的离谱.一到夏天温度上了30度就很容易触发超过60度过热关机.实际上就j1900的功耗发热情况来看会过热关机纯粹就是机箱问题.

蜗牛星际的主板尺寸是一块标准的itx板,但cpu是集成在主板上的而且自带了一个无法拆卸的被动散热.被动散热本身没啥问题,但热量排不出去就有问题了.因此蜗牛星际的散热改造主要是改造风道.

改造风道可以看做是如下几个方面的改造

1. 设计风道
2. 替换出风风扇
3. 增加进风风扇
4. 辅助cpu散热
5. 更换电源

有说法蜗牛星际的风扇无法pwm调速的,但我的可以,只是需要在BIOS中设置,而且只能根据cpu温度来控温.因此,有条件的话还是上pwm风扇比较好.

### 设计风道

这个机器是典型的前进后出机箱,前方进气,后方排气.考虑到整机的的实际发热量其实并不大,比较合理的设计是做成正压机箱,前面进风口配风压扇配防尘网,后面出风口配风量扇也配防尘网,这样散热够用,机箱也不会有太多灰.

这个机箱在侧面板上是有几个开口的,为了构造风道,我们需要将他们都拿胶布贴上,这样风道设计其实就完成了

### 替换出风风扇

出风风扇建议使用8025扇或者8015扇.8025扇选择比较多,出风也大,但缺点是安装比较费劲,而且容易被背板的线干涉.这里给出两个方案

+ 8015扇+8cm防尘网方案.8015风扇我只找到利民家有,直接安装即可,记得从外到内是`防尘网->机箱背板->风扇`而且记得风扇要向外吹风
+ 8025扇+8cm风扇防护网+8cm防尘网方案.8025就很好找了,几乎每家做风扇的都有,要静音可以买猫头鹰(120元左右).记得从外到内是`防尘网->机箱背板->风扇->防护网`而且记得风扇要向外吹风

### 增加进风风扇

进风风扇个人建议从直接外挂一个14025风扇.蜗牛星际的前面板是铁网,我们可以利用这个用磁吸的方式固定风扇向硬盘笼吹风.我现在是3块硬盘在硬盘笼里,至少目前看可以稳稳压住.至于插满四块,我没有测试过不好下结论.由于风扇裸露在外,如果家里有小朋友最好也装个防护网.这样从外到内是`防尘网->防护网->风扇->磁吸螺丝的磁吸头->机箱前面板`.需要注意的是

1. 14025风扇好买,几乎每家做风扇的都有,但磁吸螺丝不能买25mm风扇用的,因为挂上防尘网和防护网后螺丝会不够长,建议买那种30mm风扇用的.
2. 吸螺丝的磁吸头和机箱前面板间也是有间隙的,可以用电工胶贴着面板裹上几圈改善风道

实际上蜗牛星际的前面板预留了一个4cm风扇的开口在底部cpu那边,但4cm风扇普遍噪音很大,nas是放在家里24小时运转的肯定不能噪音太大,因此不建议安装,如果非要安装,建议上猫头鹰的4020风扇(110元左右).

### 辅助cpu散热

cpu被动散热顶部到挡板大致还有19mm的空间,我们可以给它挂上一个上吹风的8015风扇,至于固定,我是用捆扎带直接绑在主板上的.这样cpu的热量可以被吹向上方开口,被后方排风扇排出机箱,8015风扇不太好找,我只找到了利民有.

### 更换电源

电源其实也是发热大头,自带是个zumax的150w电源,据说电压不稳,容易造成掉盘.而且电源最大功率越高,发热越低,噪音也越低.我就换成了海韵的ssp-300sug.这是一个300w电源,妥妥的大马拉小车.

所以整个散热改造下来即便不用猫头鹰风扇,成本也比蜗牛星际本体高了...

## 硬盘分配

这个机器我给它暂时配的硬盘是

+ msata ssd 1T x1
+ sata ssd 1T x1
+ sata 机械 2T x3

计划将两个ssd组成一个存储空间放软件和热数据,剩下的机械硬盘组成一个存储空间放冷数据和照片什么的.

后续如果空间不够用了可能会先加一块4T的机械硬盘,然后慢慢替换老的2T盘

## 安装

准确的说应该是重装.之前


## 相册功能

安装官方插件Synology Photos即可,它会依赖插件Synoloy Drive Server,因此会安装比价久.

这个插件和dsm 6的照片管理逻辑不一样,文件存放路径也不一样,因此如果是迁移,我们只能手动改文件路径


## 内部TM


## 外网访问

最早我家是使用的外网的一个ddns服务,但自从运营商强制换了光猫后ddns就失效了(ddns打开的成了光猫的设置页).于是我就买个了[DDNSTO](https://web.ddnsto.com/)的8m带宽服务(一年79块,其实感觉4m带宽的也够用).

成功设置后目前可以顺利从外网连到家里,但这个方案有如下几个缺陷:

+ 内网映射只支持http/https协议,其他的所谓应用也只支持为数不多的几种,也就是说有些功能就被锁死或者体验很难好了.
+ 每次从外网连都需要认证.这个认证要么是扫码要么是要安装它专用的app进去点击验证.多这一步操作还是挺麻烦

以后如果换了运营商我估计会换别的方案,但目前用着还行,够用

<!-- [no.ip](https://www.noip.com/) -->

## 启用docker

安装官方插件container manager即可.这个插件支持本地docker-compose部署.基本上也就不需要安装portainer了.

## 作为内网网络硬盘


## 云下载

云下载可以使用[Aria2](https://github.com/aria2/aria2),它使用docker安装,镜像使用的是[p3terx/aria2-pro](https://hub.docker.com/r/p3terx/aria2-pro).为啥用它呢,这个主要是因为`DDNSTO`只提供了对它的支持.

安装也很简单

1. 去群辉的设置中打开ssh
2. 在群辉的文件系统中新建文件夹用存放配置和下载到的内容,我这里是分别新建的共享文件夹,配置放在软件的存储空间(`/volume1/software/docker_deploy/aria2_config`),下载内容放在冷数据的存储空间(`/volume2/PTDownload`)
3. 按如下这个docker命令去配置容器

    ```bash
    docker run -d \
        --name aria2-pro \
        --network host \
        -e RPC_SECRET=<TOKEN> \
        -e RPC_PORT=6800 \
        -e LISTEN_PORT=6888 \
        -v <配置文件夹地址>:/config \
        -v <下载文件夹地址>:/downloads \
        p3terx/aria2-pro
    ```

其中`TOKEN`就是你自己设置的连接时的密码,记好了后面再DDNSTO中设置时会用到.

1. 进入DDNSTO的控制台,在`远程应用`中点`+`号,创建一个`远程Aria2`应用,填入应用名,url就是`http://<群辉机器的地址>:6800/jsonrpc`,密码填这个`TOKEN`的值即可

## 播视频

jellyfin

## 提供数据库服务

## 提供oss服务

## 提供代码仓库服务

