---
layout: post
title: "玩转Envoy."
date: 2021-05-26
author: "Hsz"
category: introduce
tags:
    - Middleware
    - WebTech
header-img: "img/home-bg-o.jpg"
series:
    security-tech:
        index: 2
update: 2021-05-26
---
# 玩转Envoy

Envoy是一个全功能的代理中间件,在k8s语境下是事实标准.

<!--more-->

前面我们已经介绍过nginx,它虽然也可以用作代理,而且性能优越,但缺乏一些关键特性让他使用起来没有那么方便,envoy可以理解为为了解决nginx一些功能缺失而生的工具.它的主要特性有:

1. 支持动态配置(服务注册和发现)
2. 支持健康检查
3. grpc作为一等公民支持良好
4. 易于集成统计与监控
5. 可以限流

现在k8s语境下几乎所有的组件都基于它和grpc在构建,因此说它是事实标准.

由于我们前面已经介绍过nginx了这边就不细说那些nginx支持的特性和已经介绍过的术语了

## 架构

envoy一般在生产环境是组网使用,也就是按层次传递请求和响应.整个代理的业务架构如下

![层次结构](../img/in-post/envoy/basic-concept.png)

Concept|概念|描述
---|---|---
`Host`|主机|能够进行网络通信的实体(如移动设备,服务器上的应用程序).在Envoy,主机是逻辑网络应用程序.一块物理硬件上可能运行有多个主机,只要它们是可以独立寻址的.
`Downstream`|下游|和nginx中一致,下游主机连接到`Envoy`,发送请求并接收响应.
`Upstream`|上游|上游主机接收来自Envoy的连接和请求,并返回响应.
`Mesh`|网格|一组主机,协调好以提供一致的网络拓扑.在本文档中`Envoy mesh`是一组`Envoy`代理,它们构成了分布式系统的消息传递基础.这个分布式系统由很多不同服务和应用程序平台组成.
`Runtime configuration`|运行时配置|外置实时配置系统,和`Envoy`一起部署.可以更改配置设置,影响操作而无需重启`Envoy`或更改主要配置.

而在每个envoy实例内部其结构如下:

![内部结构](../img/in-post/envoy/forward-concept.png)

Concept|概念|描述
---|---|---
`Listener`|监听器|监听器是命名网地址(例如端口,unix domain socket等),可以被下游客户端连接.`Envoy`暴露一个或者多个监听器给下游主机连接
`Router`|路由|路由是一组将虚拟主机(virtual hosts)与群集(cluster)匹配的规则(rule),允许创建流量转移规则
`Cluster`|集群|集群是指`Envoy`连接到的逻辑上相同的一组上游主机
`Endpoint`|端点|Envoy将`端点(Endpoint)`定义为群集(Cluster)中可用的IP和端口

## Service Mesh

服务网格

### Sidecar模式(挂件模式)

`Envoy`通常被用做Sidecar模式的组件,,我们可以将这种模式理解为挂载组件.一般一个`Envoy`实例会分为两种:




### 数据平面与控制平面

数据平面指的是负责有条件地转换,转发以及观察进出服务实例的每个网络包,而控制平面则是控制数据平面的工具.

`Envoy`将自身定义为数据平面,并希望使用者可以通过控制平面(主要是xds接口协议)来为Envoy提供动态配置.




## 安装

envoy要么源码编译安装要么直接使用docker,通常大家都是使用docker来运行envoy的.官方提供了`linux/amd64`和`linux/arm64`两种最常见的平台的镜像,使用`docker pull envoyproxy/envoy`就可以拉取得到.

## 使用流程

envoy的启动和nginx一样需要指定配置,在读取完配置之后如果在配置中有设置动态配置的部分则

## 为http服务做代理

### 静态配置

### 动态配置

### 健康检查

## 为grpc做代理

### 静态配置

### 动态配置

### 健康检查

### grpc-web支持

## 集成prometheus